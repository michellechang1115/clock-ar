<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <script src="https://cdn.jsdelivr.net/npm/p5@1.4.0/lib/p5.js"></script>
    <title>Cairn</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <script>
        async function callClaudeAPI() {
            const button = document.getElementById('apiButton');
            const resultDiv = document.getElementById('result');
            button.disabled = true;
            resultDiv.textContent = 'Calling API...';

            try {
                const response = await fetch('http://localhost:5001/api/claude', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    mode: 'cors', // Explicitly set CORS mode
                    body: JSON.stringify({
                        model: "claude-3-haiku-20240307",
                        max_tokens: 300,
                        system: "You are a world class poet and philosopher. Response with short poems only, no introduction is needed.",
                        messages: [
                            {
                                role: "user",
                                content: "Write a haiku about the connection between winter and home"
                            }
                        ]
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                resultDiv.textContent = data.content[0].text;
            } catch (error) {
                resultDiv.textContent = `Error: ${error.message}`;
                console.error('Detailed error:', error);
            } finally {
                button.disabled = false;
            }
        }
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
            font-family: 'Inter', sans-serif;
            background-color: #f0f0f0;
            margin: 0;
        }
        h1 {
            margin-bottom: 100px;
            color: #333;
            font-weight: 400;
            font-size: 15px;
        }
        /* .button-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0px;
            width: 350px;
        }
        .emotion-button {
            padding: 15px;
            font-size: 13px;
            font-family: 'Inter', sans-serif;
            background-color: #d9d9d9;
            color: #5C5C5C;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        .emotion-button:hover {
            background-color: #7EFCA0;
        } */
        .ellipse-container {
            text-align: center;
            max-width: 600px;
            padding: 20px;
        }
        #ellipse-big {
            position: relative;
            width: 200px;
            height: 100px;
            background-color: beige;
            border-radius: 50%;
            /* margin: 0 auto 30px; */
            overflow: hidden;
            transition: transform 2s ease-in-out;
        }
        #ellipse-medium {
            position: relative;
            width: 150px;
            height: 80px;
            background-color: beige;
            border-radius: 50%;
            /* margin: 0 auto 30px; */
            overflow: hidden;
            transition: transform 2s ease-in-out;
        }
        #ellipse-small {
            position: relative;
            width: 70px;
            height: 50px;
            background-color: beige;
            border-radius: 50%;
            /* margin: 0 auto 30px; */
            overflow: hidden;
            transition: transform 2s ease-in-out;
        }
        #texture-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url('textures/stone.jpg');
            background-size: cover;
            background-repeat: no-repeat;
            opacity: 0.3; /* Adjust opacity as needed */
            mix-blend-mode: normal; /* Experiment with different blend modes */
        }
    </style>
</head>
<body>

    <!-- <h1>Claude API Proxy Client</h1>
    <button id="apiButton" onclick="callClaudeAPI()">Call Claude API</button>
    <div id="result" style="margin-top: 20px; padding: 10px; border: 1px solid #ccc; min-height: 100px;"></div> -->

    <!-- <h1>How are you feeling?</h1>
    <div class="button-grid">
        <button class="emotion-button" onclick="redirectToMeditation('anxious')">anxious</button>
        <button class="emotion-button" onclick="redirectToMeditation('overwhelmed')">overwhelmed</button>
        <button class="emotion-button" onclick="redirectToMeditation('frustrated')">frustrated</button>
        <button class="emotion-button" onclick="redirectToMeditation('peaceful')">peaceful</button>
        <button class="emotion-button" onclick="redirectToMeditation('bored')">bored</button>
        <button class="emotion-button" onclick="redirectToMeditation('agitated')">agitated</button>
    </div> -->

    <a-entity id="character-container" style="margin-bottom: -300px;"></a-entity>

    <!-- <div class="ellipse-container" style="margin-top:-300px;  margin-bottom: 0px;">
        <div id="ellipse-small" style="margin-left: 50px">
            <div id="texture-overlay"></div>
        </div>
        <div id="ellipse-medium">
            <div id="texture-overlay"></div>
        </div>
        <div class="ellipse-big-1" id="ellipse-big">
            <div id="texture-overlay"></div>
        </div>
    </div> -->

    <canvas id="ellipse-canvas" style="margin-top: -550px;"></canvas>

    <script>
        function redirectToMeditation(emotion) {
            // Encode the emotion to handle spaces and special characters
            window.location.href = `meditation.html?emotion=${encodeURIComponent(emotion)}`;
        }

        // P5.js sketch for random characters
        let characters = [];
        let N;
        let canvas;

        // Listener for resizing
        // function resizeCanvas() {
        //     canvas.width = window.innerWidth;
        //     canvas.height = window.innerHeight;
        // }
        // resizeCanvas();
        // window.addEventListener('resize', resizeCanvas);

        function setup() {
            canvas = createCanvas(window.innerWidth, window.innerHeight);
            console.log("width: " + window.innerWidth);
            console.log("height: " + window.innerHeight);
            canvas.parent('character-container');
            textAlign(CENTER, CENTER);
            textSize(10);

            // Calculate the number of characters based on the window size
            N = window.innerWidth * window.innerHeight / 4500;

            // Generate initial random characters
            for (let i = 0; i < N; i++) {
                characters.push({
                    x: random(width),
                    y: random(height),
                    char: char(int(random(33, 126))),
                    // color: color(random(255), random(255), random(255))
                    color: color(0, 0, 0)
                });
            }
        }

        function draw() {
            clear();

            // Draw scattered characters
            characters.forEach(char => {
                fill(char.color);
                text(char.char, char.x + random(1.5), char.y + random(1.5));
            });
        }

        // elipses
        const ellipseCanvas = document.getElementById('ellipse-canvas');
        const ctx = ellipseCanvas.getContext('2d');

        ellipseCanvas.width = window.innerWidth;
        ellipseCanvas.height = window.innerHeight;

        let ellipseY = window.innerHeight-30;

        // texture
        // const stoneTexture = new Image;
        // stoneTexture.src = "/textures/stone.jpg"; 

        // stoneTexture.onload = function() {
        //     // Create a pattern from the image
        //     const pattern = ctx.createPattern(stoneTexture, 'repeat');
        //     // Set the fill style to the pattern
        //     ctx.fillStyle = pattern;
        // }

        // Function to draw a random ellipse
        function drawRandomEllipse(x, y) {
            // Random ellipse parameters
            const width = Math.random() * 150 + 50; // 50-200 width
            const height = Math.random() * 20 + 50; // 30-100 height
            const rotation = Math.random() * Math.PI / 2 - Math.PI / 4; // Random rotation
            
            // Save canvas state
            ctx.save();

            // Translate to click position
            ctx.translate(window.innerWidth/2, ellipseY-height/2);
            ellipseY -= height;
            
            // Rotate
            ctx.rotate(rotation);

            // Set random fill color
            ctx.fillStyle = '#ffffff';

            // Draw ellipse
            ctx.beginPath();
            ctx.ellipse(0, 0, width / 2, height / 2, 0, 0, Math.PI * 2);
            ctx.fill();
            

            // Restore canvas state
            ctx.restore();

            // Log ellipse details
            console.log({
                x, 
                y, 
                width, 
                height, 
                rotation: rotation * 180 / Math.PI, // convert to degrees
                color: ctx.fillStyle
            });

            if (ellipseY < 0) {
                ctx.clearRect(0, 0, window.innerWidth, window.innerHeight);
                ellipseY = window.innerHeight-30;
            }
        }

        ellipseCanvas.addEventListener('click', (e) => {
            // Get click coordinates
            const rect = ellipseCanvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            // Draw random ellipse at click location
            drawRandomEllipse(x, y);
        });

    </script>

</body>
</html>